<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অটোমেটিক অ্যাড মানি | PanelShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0f172a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); transition: all 0.3s; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div class="glass-card p-8 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-bold text-center mb-6 text-blue-400">
            <i class="fas fa-wallet mr-2"></i>অটোমেটিক অ্যাড মানি
        </h2>

        <div id="statusBanner" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>

        <div class="space-y-4">
            <div>
                <label class="block text-gray-400 mb-1">টাকার পরিমাণ (BDT)</label>
                <input type="number" id="inputAmount" placeholder="যেমন: 500" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg focus:outline-none focus:border-blue-500">
            </div>

            <div>
                <label class="block text-gray-400 mb-1">ট্রানজেকশন আইডি (TrxID)</label>
                <input type="text" id="inputTrx" placeholder="যেমন: TEST1234" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg focus:outline-none focus:border-blue-500 uppercase">
            </div>

            <button onclick="processPayment()" id="submitBtn" class="btn-primary w-full p-4 rounded-xl font-bold text-lg shadow-lg">
                ভেরিফাই করুন
            </button>
        </div>

        <div class="mt-6 text-xs text-gray-500 text-center">
            <p>আপনার পাঠানো টাকা ১-২ মিনিটের মধ্যে একাউন্টে যোগ হবে।</p>
        </div>
    </div>

    <script>
        const DB_URL = "https://panelshop-71ed8-default-rtdb.firebaseio.com";

        async function processPayment() {
            const amount = document.getElementById('inputAmount').value;
            const trx = document.getElementById('inputTrx').value.trim().toUpperCase();
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('statusBanner');

            // ১. ইনপুট যাচাই
            if (!amount || !trx) {
                showAlert("সবগুলো ঘর পূরণ করুন!", "bg-red-500/20 text-red-400");
                return;
            }

            // বাটন লক করা
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ভেরিফাই করা হচ্ছে...';
            showAlert("সার্ভারের সাথে যোগাযোগ করা হচ্ছে...", "bg-blue-500/20 text-blue-400");

            try {
                // ২. ফায়ারবেস থেকে মেসেজ লগ আনা
                const response = await fetch(`${DB_URL}/sms_logs.json`);
                const logs = await response.json();

                let foundMatch = false;
                let logKey = "";

                if (logs) {
                    for (let key in logs) {
                        const sms = logs[key];
                        const content = sms.content.toUpperCase();
                        
                        // ৩. ট্রানজেকশন আইডি এবং টাকার পরিমাণ মেসেজে আছে কি না দেখা
                        // এবং মেসেজটি আগে ব্যবহার হয়েছে কি না চেক করা (isUsed: false)
                        if (content.includes(trx) && content.includes(amount) && (sms.isUsed === false || sms.isUsed === "false")) {
                            foundMatch = true;
                            logKey = key;
                            break;
                        }
                    }
                }

                if (foundMatch) {
                            if (foundMatch) {
            // ইউজারের আইডি আনা
            const userId = localStorage.getItem("userId");
            
            if (!userId) {
                showAlert("লগইন আইডি পাওয়া যায়নি! আবার লগইন করুন।", "bg-red-500/20 text-red-400");
                resetButton();
                return;
            }

            try {
                // ১. ফায়ারস্টোর (Firestore) থেকে ইউজারের বর্তমান ব্যালেন্স চেক
                const userRef = db.collection("users").doc(userId);
                const doc = await userRef.get();

                if (!doc.exists) {
                    showAlert("ইউজার ডাটা পাওয়া যায়নি!", "bg-red-500/20 text-red-400");
                    resetButton();
                    return;
                }

                const currentBalance = parseFloat(doc.data().balance || 0);
                const newBalance = currentBalance + parseFloat(amount);

                // ২. ফায়ারস্টোরে নতুন ব্যালেন্স আপডেট
                await userRef.update({
                    balance: newBalance
                });

                // ৩. ট্রানজেকশনটি 'Used' হিসেবে মার্ক করা (Realtime Database-এ)
                await fetch(`${DB_URL}/sms_logs/${logKey}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({ isUsed: true, usedBy: userId })
                });

                showAlert("অভিনন্দন! সফলভাবে ৳" + amount + " যোগ করা হয়েছে।", "bg-green-500/20 text-green-400");
                
                setTimeout(() => {
                    window.location.href = "index.html"; 
                }, 3000);

            } catch (error) {
                console.error("Error:", error);
                showAlert("ব্যালেন্স আপডেট করতে সমস্যা হয়েছে!", "bg-red-500/20 text-red-400");
                resetButton();
            }
        }

                    }, 3000);

                } else {
                    showAlert("রিজেক্ট! ট্রানজেকশন আইডি ভুল অথবা টাকা জমা হয়নি।", "bg-red-500/20 text-red-400");
                    resetButton();
                }

            } catch (error) {
                showAlert("সার্ভার ত্রুটি! আবার চেষ্টা করুন।", "bg-red-500/20 text-red-400");
                resetButton();
            }
        }

        function showAlert(msg, classes) {
            const status = document.getElementById('statusBanner');
            status.className = `p-3 rounded-lg text-sm text-center ${classes}`;
            status.innerHTML = msg;
            status.classList.remove('hidden');
        }

        function resetButton() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.innerHTML = 'ভেরিফাই করুন';
        }
    </script>
</body>
</html>
